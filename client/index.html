<!html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SocketChat</title>
	<link rel="stylesheet" href="./css/font-awesome.min.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.0/css/bulma.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/balloon-css/0.4.0/balloon.min.css">
</head>

<body class='container'>
	<div class='' style="padding: 1em;">
		<div class="columns is-three-quarter-tablet">
		  <div id='dataout' class="column">
			<span class='title is-2'>Chat</span> | <span id="connection-status">Offline</span> | <span id="user-count"></span>				
					<ul id='chat' class='box' style='min-height: 62vh; max-height: 80vh; overflow-y: auto; color:white; background: teal;'>
					</ul>			
		  </div>
			 <div id='dataout' class="column is-one-quarter-tablet is-hidden-mobile">
			<span class='title is-2'> <span class='icon is-medium' style='position: relative; top: .2em; left: .15em;'><i class="fa fa-users" aria-hidden="true"></i></span> Users</span>			
					<ul id='clientList' class='box is-info' style='min-height: 62vh; max-height: 80vh; overflow-y: auto; color:white; background: orange;'>
					</ul>	
		  </div>
		</div>
		<div>
			<form onsubmit='javascript:sendChatMessageToServer()' action="javascript:void(0);">
				<div class="field has-addons">
					<div id='input-tooltip' data-balloon-pos="down"></div>
					<p class="control is-expanded">
						<input class="input" type="text" placeholder="Message">
					</p>
					<p class="control">
						<button class='button is-primary' onclick='javascript:sendChatMessageToServer();'><i class='fa fa-paper-plane' aria-hidden='true'></i></button>
					</p>			
				</div>
			</form>
		</div>
	</div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
<script>
	var socket = io('http://localhost:3131');	

	var clientListDOM = $('#clientList');
	var clientList = [];
	var chat = $('#chat');
	var chatHistory = [];
	var chatById = document.getElementById('chat');
	var connectionStatus = $('#connection-status');
	var userCount = $('#user-count');
	var clientName = localStorage.getItem('username');
	var input = $('input:text');
	var inputTooltip = $('#input-tooltip');
	var chatHistoryIndex = -1;
	sendUserNameToServer();
	socket.emit('initialize', {});

	$(document).keydown(function (e) {
		switch(e.which) {
			case 38: 			
						if(chatHistoryIndex < chatHistory.length) {
							chatHistoryIndex++;
						}
						input.val(chatHistory[chatHistoryIndex]);
						break;
			case 40:
						if(chatHistoryIndex > 0) {
							chatHistoryIndex--;
						}
						input.val(chatHistory[chatHistoryIndex]);
						break;
		}
	});

	input.on('change', function () {
			if(input.val()[0] == '@'){
				inputTooltip.attr('data-balloon-visible', '');
				inputTooltip.attr('data-balloon', clientList.join(', @'));
			} else {
				inputTooltip.removeAttr('data-balloon-visible')
				inputTooltip.attr('data-balloon', '');
			}
	});
	
  socket.on('updateClientList', function (data) {
		clientList = data.clientIdList;
		clientListDOM.html('');
		userCount.html('Users: ' + data.clientIdList.length);
		data.clientIdList.forEach( function (client) {
			if(client == clientName){
				clientListDOM.append('<li><span style="position: relative;left: -3px;"><i class="fa fa-user-circle-o" aria-hidden="true" style="line-height: 1em;"></i></span> '+client+'</li>');
			} else {
				clientListDOM.append('<li><i class="fa fa-user" aria-hidden="true" style="line-height: 1em;"></i> '+client+'</li>');
			}		
		});
  });

	socket.on('connect', function () {
		connectionStatus.html('Online')
	});
	socket.on('disconnect', function () {
		connectionStatus.html('Offline')
	});

	socket.on('updateClientChat', function (data) {		 	
		printMessagesToChatWindow(data);
  });

	socket.on('updatePrivateMessage', function (data) {	
		printMessagesToChatWindow(data);
  });

	function printMessagesToChatWindow (data) {
		if(data.message) {
				data.message.forEach( function (message) {
					chat.append('<li>'+message+'</li>');	
				});		
				chatById.scrollTop = chatById.scrollHeight;
			}
	}

	function sendUserNameToServer () {
			var username = localStorage.getItem('username') || prompt("Please enter your name:", "");		
			socket.emit('setUsername', { username: username});
			localStorage.setItem('username', username);
	}
  
  function sendChatMessageToServer () {
				socket.emit('datain', { 'input' : input.val()});
				if(input.val() && input.val() != chatHistory[0]) {
					chatHistory.unshift(input.val());
					console.log(chatHistory);
				}
				chatHistoryIndex = -1;
				input.val('');
  }
</script>

</html>